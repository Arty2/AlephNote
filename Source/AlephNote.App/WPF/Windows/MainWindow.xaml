<Window x:Class="AlephNote.WPF.Windows.MainWindow"
		xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
		xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
		xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
		xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
		xmlns:windows="clr-namespace:AlephNote.WPF.Windows"
		xmlns:services="clr-namespace:MSHC.WPF.Extensions.Services;assembly=CSharpUtils"
		xmlns:conv="clr-namespace:AlephNote.WPF.Converter"
		xmlns:scinet="clr-namespace:ScintillaNET;assembly=ScintillaNET"
		xmlns:proxy="clr-namespace:MSHC.WPF.Extensions.BindingProxies;assembly=CSharpUtils"
		xmlns:controls="clr-namespace:MSHC.WPF.Controls;assembly=CSharpUtils"
		xmlns:ctrl="clr-namespace:AlephNote.WPF.Controls"
		xmlns:tb="http://www.hardcodet.net/taskbar"
		xmlns:mext="clr-namespace:MSHC.WPF.Extensions.MarkupExtensions;assembly=CSharpUtils"
		xmlns:settings="clr-namespace:AlephNote.Settings"
		xmlns:pi="clr-namespace:AlephNote.PluginInterface;assembly=AlephNote.PluginInterface"
		mc:Ignorable="d" 
		Icon="/Resources/IconMain.png"
		WindowState="{Binding WindowState}"
		d:DataContext="{d:DesignInstance windows:MainWindowViewmodel}"
		ResizeMode="CanResizeWithGrip"
		StateChanged="{mext:EventBinding StateChangedEvent, CommandParameter=$e}"
		Closing="{mext:EventBinding ClosingEvent, CommandParameter=$e}"
		Closed="{mext:EventBinding CloseEvent, CommandParameter=$e}"
		Loaded="MainWindow_OnLoaded"
		KeyDown="MainWindow_OnKeyDown"
		Title="Common Note" Height="350" Width="525">
	
	<Window.InputBindings>
		<KeyBinding Command="{Binding CreateNewNoteCommand}" Modifiers="Control" Key="N"/>
		<KeyBinding Command="{Binding SaveAndSyncCommand}" Modifiers="Control" Key="S"/>
	</Window.InputBindings>
	
	<Grid x:Name="LayoutRoot">
		<Grid.ColumnDefinitions>
			<ColumnDefinition Width="{Binding OverviewListWidth, Mode=TwoWay}"/>
			<ColumnDefinition Width="Auto"/>
			<ColumnDefinition Width="2*"/>
		</Grid.ColumnDefinitions>
		<Grid.RowDefinitions>
			<RowDefinition Height="Auto"/>
			<RowDefinition Height="1*"/>
			<RowDefinition Height="Auto"/>
		</Grid.RowDefinitions>

		<Menu Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="3" >
			<MenuItem Header="File">
				<MenuItem Header="New Note" Command="{Binding CreateNewNoteCommand}" />
				<Separator />
				<MenuItem Header="Export Note" Command="{Binding ExportCommand}" />
				<MenuItem Header="Delete Note" Command="{Binding DeleteCommand}" />
				<Separator />
				<MenuItem Header="Exit" Command="{Binding ExitCommand}" />
			</MenuItem>
			<MenuItem Header="Edit">
				<MenuItem Header="Settings" Command="{Binding SettingsCommand}" />
				<MenuItem Header="Synchronize now" Command="{Binding ResyncCommand}" />
			</MenuItem>
			<MenuItem Header="Help">
				<MenuItem Header="Check for Updates" />
				<MenuItem Header="About" Command="{Binding ShowAboutCommand}" />
			</MenuItem>
		</Menu>

		<Grid Margin="1" Grid.Column="0" Grid.Row="1">
			<Grid.ColumnDefinitions>
				<ColumnDefinition Width="1*"/>
				<ColumnDefinition Width="26"/>
			</Grid.ColumnDefinitions>
			<Grid.RowDefinitions>
				<RowDefinition Height="Auto"/>
				<RowDefinition Height="1*"/>
			</Grid.RowDefinitions>

			<controls:ClickSelectTextBox Grid.Row="0" Margin="0,2" Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}">
				<services:WatermarkService.Watermark>
					<TextBlock Text="Search" Padding="5,0"/>
				</services:WatermarkService.Watermark>
			</controls:ClickSelectTextBox>

			<Button Grid.Row="0" Grid.Column="1" Content="+" Margin="2" Background="Transparent" BorderThickness="0" FontWeight="Bold" Command="{Binding CreateNewNoteCommand}"/>

			<ListView Grid.Column="0"  Grid.Row="1" Grid.ColumnSpan="2"
					  services:MultiDatatemplateService.MultiTemplateSelector="{Binding Settings.NotePreviewStyle}"
					  HorizontalContentAlignment="Stretch"
					  ScrollViewer.HorizontalScrollBarVisibility="Hidden"
					  ItemsSource="{Binding NotesView}" 
					  SelectedValue="{Binding SelectedNote}"
					  FontSize="{Binding Settings.ListFontSize, Converter={conv:FontSizeToInt}}" 
					  FontFamily="{Binding Settings.ListFontFamily}" 
					  FontWeight="{Binding Settings.ListFontModifier, Converter={conv:FontModifierToFontWeight}}" 
					  FontStyle="{Binding Settings.ListFontModifier, Converter={conv:FontModifierToFontStyle}}">
				
				<ListView.InputBindings>
					<KeyBinding Command="{Binding DeleteCommand}" Key="Delete"/>
				</ListView.InputBindings>
				
				<ListView.ContextMenu>
					<ContextMenu>
						<MenuItem Header="Export" Command="{Binding ExportCommand}" />
						<MenuItem Header="Delete" Command="{Binding DeleteCommand}" />
					</ContextMenu>
				</ListView.ContextMenu>
				
				<ListView.ItemTemplate>
					<DataTemplate>
					</DataTemplate>
				</ListView.ItemTemplate>

				<!-- ReSharper disable Xaml.RedundantResource -->
				<services:MultiDatatemplateService.MultiTemplate>

					<services:ConditionalDataTemplate Value="{x:Static settings:NotePreviewStyle.Simple}" d:DataContext="{d:DesignInstance pi:INote}">
						<DataTemplate >
							<Grid Width="{Binding RelativeSource={RelativeSource AncestorType={x:Type VirtualizingStackPanel}}, Path=ActualWidth, Converter={conv:Subtract}, ConverterParameter=3}">
								<TextBlock Text="{Binding Title, Converter={conv:StringCoalesce}, ConverterParameter='New Note...'}" TextTrimming="CharacterEllipsis" />
							</Grid>
						</DataTemplate>
					</services:ConditionalDataTemplate>

					<services:ConditionalDataTemplate Value="{x:Static settings:NotePreviewStyle.Extended}" d:DataContext="{d:DesignInstance pi:INote}">
						<DataTemplate>
							<Grid Width="{Binding RelativeSource={RelativeSource AncestorType={x:Type VirtualizingStackPanel}}, Path=ActualWidth, Converter={conv:Subtract}, ConverterParameter=3}">
								<Grid.ColumnDefinitions>
									<ColumnDefinition Width="*" />
									<ColumnDefinition Width="Auto" />
								</Grid.ColumnDefinitions>
								<TextBlock Grid.Column="0" Text="{Binding Title, Converter={conv:StringCoalesce}, ConverterParameter='New Note...'}" TextTrimming="CharacterEllipsis" />
								<TextBlock Grid.Column="1" Text="{Binding ModificationDate, Converter={conv:SmallDateTimeToDisplay}}" VerticalAlignment="Center" Foreground="DimGray" >
									<TextBlock.LayoutTransform>
										<ScaleTransform ScaleX="0.9" ScaleY="0.9" />
									</TextBlock.LayoutTransform>
								</TextBlock>
							</Grid>
						</DataTemplate>
					</services:ConditionalDataTemplate>

					<services:ConditionalDataTemplate Value="{x:Static settings:NotePreviewStyle.FullPreview}" d:DataContext="{d:DesignInstance pi:INote}">
						<DataTemplate>
							<Grid Width="{Binding RelativeSource={RelativeSource AncestorType={x:Type VirtualizingStackPanel}}, Path=ActualWidth, Converter={conv:Subtract}, ConverterParameter=3}">
								<Grid.RowDefinitions>
									<RowDefinition Height="Auto" />
									<RowDefinition Height="Auto" />
									<RowDefinition Height="Auto" />
								</Grid.RowDefinitions>
								<TextBlock Grid.Row="0" FontWeight="Bold" FontStyle="Normal" Foreground="Black" Text="{Binding Title, Converter={conv:StringCoalesce}, ConverterParameter='New Note...'}" TextTrimming="CharacterEllipsis" />
								<TextBlock Grid.Row="1" TextWrapping="Wrap">
									<Run Foreground="Brown" FontWeight="Normal" FontStyle="Normal" Text="{Binding ModificationDate, Converter={conv:SmallDateTimeToDisplay}}" />
									<Run Foreground="DarkGray" FontWeight="Normal" FontStyle="Normal" Text="{Binding Text, Converter={conv:SubstringLeft}, ConverterParameter=100}" />
								</TextBlock>
								<Separator Grid.Row="2" Background="LightGray" Margin="6,7,6,7" />
							</Grid>
						</DataTemplate>
					</services:ConditionalDataTemplate>

				</services:MultiDatatemplateService.MultiTemplate>
				<!-- ReSharper restore Xaml.RedundantResource -->

			</ListView>

		</Grid>

		<GridSplitter Grid.Row="1" Grid.Column="1" HorizontalAlignment="Stretch" Width="3" />

		<Grid Grid.Column="2" Margin="1" Grid.Row="1" Visibility="{Binding SelectedNote, Converter={conv:IsNullToVisibility}, ConverterParameter=Hidden;Visible}" >
			<Grid.ColumnDefinitions>
				<ColumnDefinition Width="1*"/>
				<ColumnDefinition Width="Auto"/>
			</Grid.ColumnDefinitions>
			<Grid.RowDefinitions>
				<RowDefinition Height="Auto"/>
				<RowDefinition Height="Auto"/>
				<RowDefinition Height="1*"/>
			</Grid.RowDefinitions>

			<TextBox Grid.Row="0" BorderBrush="Transparent" BorderThickness="0"  
					 Foreground="CornflowerBlue" 
					 FontSize="{Binding Settings.TitleFontSize, Converter={conv:FontSizeToInt}}" 
					 FontFamily="{Binding Settings.TitleFontFamily}" 
					 FontWeight="{Binding Settings.TitleFontModifier, Converter={conv:FontModifierToFontWeight}}" 
					 FontStyle="{Binding Settings.TitleFontModifier, Converter={conv:FontModifierToFontStyle}}" 
					 Text="{Binding SelectedNote.Title, UpdateSourceTrigger=PropertyChanged}" >
				<services:WatermarkService.Watermark>
					<TextBlock Text="Empty Title..." VerticalAlignment="Center" Padding="6,0"
					 FontSize="{Binding Settings.TitleFontSize, Converter={conv:FontSizeToInt}}" 
					 FontFamily="{Binding Settings.TitleFontFamily}" 
					 FontWeight="{Binding Settings.TitleFontModifier, Converter={conv:FontModifierToFontWeight}}" 
					 FontStyle="{Binding Settings.TitleFontModifier, Converter={conv:FontModifierToFontStyle}}" />
				</services:WatermarkService.Watermark>
			</TextBox>

			<ctrl:TagEditor Grid.Row="1" Grid.Column="0" TagSource="{Binding SelectedNote.Tags}" MinHeight="25" BorderThickness="0" AcceptsReturn="False" AcceptsTab="False" VerticalContentAlignment="Bottom">
				<ctrl:TagEditor.TokenTemplate>
					<DataTemplate>
						<Border VerticalAlignment="Center" Background="SeaShell" BorderThickness="1" BorderBrush="LightGray" Margin="-4,1,8,1" Padding="1">
							<TextBlock Text="{Binding .}" />
						</Border>
					</DataTemplate>
				</ctrl:TagEditor.TokenTemplate>
				<ctrl:TagEditor.Document>
					<FlowDocument>
						<Paragraph>
							<Run />
						</Paragraph>
					</FlowDocument>
				</ctrl:TagEditor.Document>
			</ctrl:TagEditor>

			<StackPanel Grid.Row="1" Grid.Column="1" VerticalAlignment="Bottom" Orientation="Horizontal" Margin="8,2">
				<TextBlock Text="*" Foreground="DarkGray" Visibility="{Binding SelectedNote.IsLocalSaved, Converter={conv:BoolToVisibility}, ConverterParameter=Collapsed;Visible}" />
				<TextBlock Text="{Binding SelectedNote.ModificationDate, Converter={conv:SmartDateTimeToDisplay}}" ToolTip="{Binding SelectedNote.ModificationDate, Converter={conv:DateTimeToDisplay}}" Foreground="DarkGray" />
			</StackPanel>

			<WindowsFormsHost Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2" x:Name="NoteEditHost">
				<WindowsFormsHost.Child>
					<scinet:Scintilla x:Name="NoteEdit" KeyPress="NoteEdit_OnKeyPress" />
				</WindowsFormsHost.Child>
			</WindowsFormsHost>

			<proxy:LegacyStringBinding Grid.Row="0" Grid.Column="0" Element="{Binding ElementName=NoteEdit}" PropertyPath="Text" ChangedEventPath="TextChanged" TargetBinding="{Binding SelectedNote.Text}" />

		</Grid>

		<StatusBar Grid.Column="0" Grid.ColumnSpan="3" Grid.Row="2">
			<StatusBar.Resources>
				<Style TargetType="StatusBarItem">
					<Setter Property="FontSize" Value="10" />
				</Style>
			</StatusBar.Resources>

			<StatusBarItem  Content="Last Synchronized: " />
			<StatusBarItem Content="{Binding LastSynchronizedText}" />
			<Button Content="R" Padding="0" Command="{Binding ResyncCommand}" ToolTip="Synchronize Now">
				<Button.LayoutTransform>
					<ScaleTransform ScaleX="1" ScaleY="0.6" />
				</Button.LayoutTransform>
			</Button>
			<Separator Margin="5,2" Foreground="Beige" />
			<StatusBarItem Content="Length: " />
			<StatusBarItem Content="{Binding SelectedNote.Text.Length, FallbackValue=''}"/>
			<StatusBarItem Content="Lines: " />
			<StatusBarItem Content="{Binding SelectedNote.Text, Converter={conv:TextToLines}, FallbackValue=''}"/>
			<StatusBarItem Content="Synchronized: " />
			<StatusBarItem Content="{Binding SelectedNote.IsRemoteSaved, FallbackValue='?'}"/>
			<StatusBarItem Content="{Binding Repository.ConnectionName}" HorizontalAlignment="Right" Margin="0,0,15,0"/>
		</StatusBar>

		<tb:TaskbarIcon Grid.Column="0" Grid.Row="0"
			x:Name="TrayIcon"
			Visibility="Visible"
			ToolTipText="{Binding FullVersion}"
			IconSource="{Binding SynchronizationState, Converter={conv:StateToAppIcon}}"
			LeftClickCommand="{Binding ShowMainWindowCommand}"
			DoubleClickCommand="{Binding ShowMainWindowCommand}">
			
			<tb:TaskbarIcon.ContextMenu>
				<ContextMenu>
					<MenuItem Header="New Note" Command="{Binding CreateNewNoteCommand}" />
					<Separator />
					<MenuItem Header="Restore" Command="{Binding ShowMainWindowCommand}" />
					<MenuItem Header="Synchronize Now" Command="{Binding ResyncCommand}" />
					<Separator />
					<MenuItem Header="Exit" Command="{Binding ExitCommand}" />
				</ContextMenu>
			</tb:TaskbarIcon.ContextMenu>
			
		</tb:TaskbarIcon>

	</Grid>
</Window>

